# i18n 重构技术方案（含实现细节与脚本全流程）

## 1. 背景与目标

- 统一前端组件中对词条的访问与渲染：TS 端统一为 `this.i18n.get(key, params?)`，HTML 端统一为 `{{ 'key' | i18n: params? }}`。
- 自动重构既有代码：识别通过 `I18nLocaleService.getLocal|getLocale()` 获得的词条对象别名（含合并对象），并将属性链、索引访问、链式 `.replace('{k}', expr)` 等全部转换为统一调用与管道。
- 读取真实词条包结构，针对“合并别名”按存在性动态选择根，避免错误 key。
- 提供 CLI 在目录上批量执行，输出变更摘要；UT 覆盖核心规则与集成流程。

## 2. 模块与职责

- `core/params-extractor.ts`：抽取链式 `.replace` 参数对象。函数 `extractReplaceParams` 位于 `i18n-demo/i18n-refactor/src/core/params-extractor.ts:3`。
- `core/var-alias.ts`：从 TS AST 收集词条别名（前缀与合并根）。核心函数 `collectVarAliases` 位于 `i18n-demo/i18n-refactor/src/core/var-alias.ts:26`。
- `core/key-resolver.ts`：将属性/索引访问解析为标准 key 表达式（含动态片段）。函数 `resolveKeyFromAccess` 位于 `i18n-demo/i18n-refactor/src/core/key-resolver.ts:5`。
- `replace/ts-replace.ts`：把解析结果渲染为统一调用。函数 `renderTsGet` 位于 `i18n-demo/i18n-refactor/src/replace/ts-replace.ts:3`。
- `replace/html-replace.ts`：把模板使用渲染为统一管道表达式。函数 `renderHtmlPipe` 位于 `i18n-demo/i18n-refactor/src/replace/html-replace.ts:3`。
- `replace/prune.ts`：清理未用的 `getLocal|getLocale` 相关赋值与声明。函数 `pruneUnused` 位于 `i18n-demo/i18n-refactor/src/replace/prune.ts:3`。
- `util/dict-reader.ts`：读取并扁平化 `src/app/i18n/{zh,en}.ts`，提供 `hasKey` 与 `pickRoot`；`pickRoot` 位于 `i18n-demo/i18n-refactor/src/util/dict-reader.ts:72`。
- `runner/component.ts`：无 IO 的组件级编排，统一 TS 与 HTML 输出；`processComponent` 位于 `i18n-demo/i18n-refactor/src/runner/component.ts:130`。
- `runner/run-dir.ts`：CLI 主流程，批量处理目录与输出摘要；`main` 位于 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:256`。

## 3. 关键实现细节

### 3.1 别名收集与合并识别

- 识别场景：类属性初始化、构造函数赋值、对象展开合并。
- 赋值前缀别名：`this.i18n = this.locale.getLocale().app.common` → 记录 `prefix='app.common'`。
- 合并别名：`dict = { ...this.locale.getLocal().common, ...this.locale.getLocal().app }` → 记录 `roots=['common','app']`。
- 参考：`collectVarAliases` 在 `i18n-demo/i18n-refactor/src/core/var-alias.ts:26` 遍历 AST，识别 `SpreadAssignment` 与 `getLocal|getLocale` 调用链。

### 3.2 参数链抽取

- 规则：`.replace('{name}', expr).replace('{count}', num)` 抽取为 `{ name: expr, count: num }`。
- 实现：正则 `/\.replace\(\s*["']\{([^}]+)\}["']\s*,\s*([^)]+)\s*\)/g`，见 `i18n-demo/i18n-refactor/src/core/params-extractor.ts:5`。

### 3.3 TS 访问统一替换

- 覆盖形态：
  - 属性链：`this.alias.a.b` → `this.alias.get('prefix.a.b')`。
  - 字面量索引：`this.alias.a['x']`/`["x"]` → `this.alias.get('prefix.a.x')`。
  - 动态索引：`this.alias.a[idx]` → `this.alias.get(''prefix.a.' + idx)`。
  - 参数链：`this.alias.t.replace('{n}', n)` → `this.alias.get('prefix.t', { n })`。
- 前缀/根组合：
  - 若别名有 `prefix`，直接拼接；避免重复首段根。
  - 若有 `roots`，通过 `pickRoot(roots, path)` 动态选择根，返回 `'<root>.<path>'`。
  - 特例 `i18n`：若首段已是常见根（如 `common`、`app`、`home`），保持；否则按候选根选择。
- 实现参考：`replaceTs` 与 `composeKey` 逻辑，见 `i18n-demo/i18n-refactor/src/runner/component.ts:46-91`；CLI 同步逻辑见 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:130-167`。
- 调用归一：所有 `this.<alias>.get(...)` 统一替换为 `this.i18n.get(...)`；见 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:175-181` 与 `i18n-demo/i18n-refactor/src/runner/component.ts:136-142`。

### 3.4 构造函数规范化

- 将 `constructor(private locale: I18nLocaleService, ...)` 改为/补充为 `constructor(public i18n: I18nService, ...)`。
- 删除构造体内所有 `this.<var> = this.locale.getLocal|getLocale(...)...` 与合并对象展开赋值；移除 `local: any;`、`dict: any;` 等残留声明。
- 参考：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:182-201` 与 `i18n-demo/i18n-refactor/src/runner/component.ts:144-151`。

### 3.5 HTML 统一管道替换

- 变量限定：仅替换本组件 TS 中识别出的别名集合（如 `i18n`、`dict`、`L`）。
- 覆盖形态：
  - 简单属性：`{{ alias.key }}` → `{{ 'root.key' | i18n }}`。
  - 索引字面量：`{{ alias.base['x'] }}` → `{{ 'root.base.x' | i18n }}`。
  - 动态索引：`{{ alias.base[idx] }}` → `{{ ('root.base.' + idx) | i18n }}`。
  - 链式参数：`{{ alias.tpl.replace('{n}', n) }}` → `{{ 'root.tpl' | i18n: { n } }}`。
- 实现参考：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:24-67, 247-254, 269-277` 与 `i18n-demo/i18n-refactor/src/runner/component.ts:93-129`。
- 支持“还原”模式：`--mode=restore` 将管道表达式还原为变量访问与 `.replace` 链；参考 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:77-101, 247-254`。

### 3.6 词条包读取与动态选根

- 读取位置：`src/app/i18n/{zh,en}.ts` 或 `srcbak/...`。
- 解析方式：剥离 `export const zh = ... as const`，安全 `Function('return (...)')()` 仅求值对象字面量；扁平化为点号路径集合。
- 接口：
  - `hasKey(root, pathInRoot)`：判断路径存在性，见 `i18n-demo/i18n-refactor/src/util/dict-reader.ts:66-70`。
  - `pickRoot(roots, pathInRoot)`：按存在性与合并顺序右→左选择根，见 `i18n-demo/i18n-refactor/src/util/dict-reader.ts:72-79`。
- CLI 覆盖目录：`--dictDir=src/app/i18n` 可指定词条目录，见 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:265-267`。

## 4. 脚本全流程（CLI 与 UT）

### 4.1 开发与测试

- 安装依赖：`npm i`（在 `i18n-demo` 根目录）。
- 运行 UT：`npm run refactor:test`（Jest 全量，参考 `i18n-demo/package.json:15`）。
- 关键测试位置：
  - `i18n-demo/i18n-refactor/tests/core/*.spec.ts`：别名、参数、键解析。
  - `i18n-demo/i18n-refactor/tests/replace/*.spec.ts`：TS/HTML 渲染与清理。
  - `i18n-demo/i18n-refactor/tests/runner/*.spec.ts`：组件级编排集成。

### 4.2 构建与运行 CLI

- 构建工具：`npm run i18n-refactor:build`（参考 `i18n-demo/package.json:16`）。
- 执行替换：`npm run i18n-refactor:run`（默认 `--dir=src --mode=replace`，参考 `i18n-demo/package.json:17`）。
- 自定义参数：
  - `--dir=<目录>`：处理的根目录，默认当前工作目录。
  - `--mode=replace|restore`：替换或还原模板。
  - `--dictDir=<目录>`：覆盖词条目录用于选根。
- 输出摘要：CLI 以 JSON 输出 `{ summary, results }`，其中 `summary={ dir, files, changed }`；见 `i18n-demo/i18n-refactor/src/runner/run-dir.ts:279-281`。

### 4.3 处理逻辑顺序（每个 TS 文件）

1) 读取 TS 文本并收集 `getLocale` 别名：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:170-173`。
2) 清理未用赋值/声明：`pruneUnused`，`i18n-demo/i18n-refactor/src/runner/run-dir.ts:171-173`。
3) 统一 TS 访问为 `.get(...)`：`replaceTsContent`，`i18n-demo/i18n-refactor/src/runner/run-dir.ts:130-167`。
4) 统一别名到 `this.i18n.get(...)` 与构造函数规范化：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:175-201, 182-190`。
5) 解析组件模板路径并替换 HTML：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:202-227, 271-277`。
6) 写回文件并记录结果：`i18n-demo/i18n-refactor/src/runner/run-dir.ts:227-229`。

## 5. 规则与边界

- TS 替换仅限定在 `this.<alias>.<...>` 访问范围，避免误伤非相关代码。
- 支持 `getLocal|getLocale` 两种拼写；赋值末尾允许可选分号与后缀属性链。
- HTML 替换限定于识别别名集合；未识别变量保持原样。
- 动态索引以字符串拼接表达式输出，保持运行时行为一致。
- 当无法从词条包解析路径时，回退到“首段即根名”的保守选择；未确定项可留存为原样。

## 6. 验证与交付

- UT 验证：运行 `npm run refactor:test`，确保 core/replace/runner 测试全部通过。
- CLI 验证：在 demo 的 `src` 目录执行一次替换，抽查 `src/app/examples/*` 与 `src/app/app.component.ts/html` 的输出形态。
- 交付物：
  - 可执行 CLI：`i18n-demo/i18n-refactor/dist/src/runner/run-dir.js`（已配置为 bin，参考 `i18n-demo/package.json:4-6`）。
  - 技术方案文档（本文件）。
  - 相关 UT 与源码位于 `i18n-demo/i18n-refactor/src` 与 `tests`。

## 7. 风险与回退策略

- 正则替换边界需谨慎；通过 UT 覆盖链式调用、索引、构造赋值、对象合并等典型场景降低风险。
- 如遇复杂构造参数排列，优先追加 `public i18n: I18nService` 而非删除既有参数；后续逐步收敛。
- 可使用 `--mode=restore` 还原模板表达式，便于对比与回退。

